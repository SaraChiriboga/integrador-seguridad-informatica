@model SGRC_Integrador.Models.Tratamiento
@{
    var historial = ViewBag.Historial as List<SGRC_Integrador.Models.TratamientoBitacora>;
    var kpis = ViewBag.KPIs as List<SGRC_Integrador.Models.TratamientoKPI>;
    Layout = null;
}

<div class="container-fluid py-4 fade-in">
    <div class="mb-4">
        <button onclick="loadView('@Url.Action("Index", "Tratamientos")')" class="btn btn-link text-navy p-0 text-decoration-none fw-bold btn-back-hover">
            <i class="fas fa-chevron-left me-2"></i> Volver al Tablero
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-lg rounded-4 sticky-top" style="top: 20px;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="icon-box bg-navy text-white rounded-3 me-3">
                            <i class="fas fa-pen-nib"></i>
                        </div>
                        <div>
                            <h4 class="fw-bold text-navy mb-0">Registrar Actividad</h4>
                            <small class="text-muted">Control de Mitigación #@Model.IdTratamiento</small>
                        </div>
                    </div>

                    <div class="p-3 mb-4 rounded-4" style="background: #f8fafc; border-left: 4px solid #0b1e3b;">
                        <small class="text-uppercase fw-bold text-muted" style="font-size:0.65rem;">Amenaza Activa</small>
                        <p class="mb-0 fw-bold text-navy">@Model.Riesgo.Amenaza</p>
                    </div>

                    <form id="formNuevaBitacora">
                        <input type="hidden" name="IdTratamiento" value="@Model.IdTratamiento" />

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Métrica Relacionada (KPI)</label>
                            <select name="IdKPI" class="form-select border-2">
                                <option value="">Mantenimiento / Operación General</option>
                                @if (kpis != null)
                                {
                                    foreach (var kpi in kpis)
                                    {
                                        <option value="@kpi.IdKPI">@kpi.NombreKPI</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Evidencia de Actividad</label>
                            <textarea name="DescripcionActividad" class="form-control border-2" rows="3" required placeholder="Describa las acciones técnicas realizadas..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted">Notas Técnicas</label>
                            <input type="text" name="ObservacionesTecnicas" class="form-control border-2" placeholder="Hallazgos o recordatorios...">
                        </div>

                        <div class="progreso-update-box p-3 rounded-4 mb-4 shadow-sm border border-primary border-opacity-10">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold text-navy small">Progreso del Plan</span>
                                <span class="badge bg-navy px-3 rounded-pill"><span id="valProgreso">@(Model.Progreso ?? 0)</span>%</span>
                            </div>
                            <input type="range" name="NuevoProgreso" class="form-range custom-range"
                                   min="0" max="100" value="@(Model.Progreso ?? 0)"
                                   oninput="$('#valProgreso').text(this.value)">
                        </div>

                        <button type="submit" id="btnGuardar" class="btn btn-navy w-100 py-3 rounded-pill fw-bold shadow-hover">
                            <i class="fas fa-check-circle me-2"></i> Actualizar Tratamiento
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="timeline-wrapper bg-white p-4 rounded-4 shadow-sm">
                <h4 class="fw-bold text-navy mb-5"><i class="fas fa-history me-2 text-primary"></i>Bitácora de Seguimiento</h4>

                <div class="modern-timeline">
                    @if (historial != null && historial.Any())
                    {
                        foreach (var log in historial.OrderByDescending(x => x.FechaRegistro))
                        {
                            DateTime f = log.FechaRegistro ?? DateTime.Now;
                            <div class="tm-item">
                                <div class="tm-info">
                                    <span class="tm-day">@f.ToString("dd")</span>
                                    <span class="tm-month">@f.ToString("MMM").ToUpper()</span>
                                    <span class="tm-time">@f.ToString("HH:mm")</span>
                                </div>
                                <div class="tm-separator">
                                    <div class="tm-dot"></div>
                                    <div class="tm-line"></div>
                                </div>
                                <div class="tm-content card border-0 shadow-sm rounded-4 mb-4">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-light text-navy fw-bold border">
                                                <i class="fas fa-user-circle me-1"></i> @log.UsuarioResponsable
                                            </span>
                                            @if (log.IdKPI != null)
                                            {
                                                <span class="badge rounded-pill bg-success-soft text-success">KPI Impactado</span>
                                            }
                                        </div>
                                        <p class="mb-2 text-dark small fw-medium">@log.DescripcionActividad</p>
                                        @if (!string.IsNullOrEmpty(log.ObservacionesTecnicas))
                                        {
                                            <div class="tm-obs p-2 rounded-3 bg-light border-start border-3 border-warning">
                                                <small class="text-muted italic"><i class="fas fa-quote-left me-1 opacity-50"></i> @log.ObservacionesTecnicas</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5 opacity-50">
                            <i class="fas fa-ghost fa-3x mb-3"></i>
                            <p>Sin registros históricos aún.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos Generales */
    .btn-back-hover:hover {
        transform: translateX(-5px);
        transition: 0.3s;
    }

    .icon-box {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .bg-success-soft {
        background: #e6fffa;
        color: #38b2ac;
    }

    .shadow-hover:hover {
        box-shadow: 0 10px 15px rgba(11, 30, 59, 0.2) !important;
    }

    /* Estilos Modern Timeline */
    .modern-timeline {
        position: relative;
        padding-bottom: 20px;
    }

    .tm-item {
        display: flex;
        gap: 20px;
    }

    .tm-info {
        min-width: 60px;
        text-align: right;
        display: flex;
        flex-direction: column;
    }

    .tm-day {
        font-size: 1.4rem;
        font-weight: 800;
        color: #0b1e3b;
        line-height: 1;
    }

    .tm-month {
        font-size: 0.7rem;
        font-weight: 700;
        color: #d62828;
    }

    .tm-time {
        font-size: 0.65rem;
        color: #94a3b8;
    }

    .tm-separator {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .tm-dot {
        width: 16px;
        height: 16px;
        background: #0b1e3b;
        border: 4px solid #e2e8f0;
        border-radius: 50%;
        z-index: 2;
        transition: 0.3s;
    }

    .tm-line {
        width: 2px;
        flex-grow: 1;
        background: #e2e8f0;
        margin-top: -2px;
    }

    .tm-item:last-child .tm-line {
        background: transparent;
    }

    .tm-content {
        flex-grow: 1;
        transition: 0.3s;
        border: 1px solid transparent !important;
    }

    .tm-item:hover .tm-content {
        transform: scale(1.02);
        border-color: #0b1e3b !important;
    }

    .tm-item:hover .tm-dot {
        background: #d62828;
        border-color: #0b1e3b;
    }
</style>

<script>
    $('#formNuevaBitacora').off('submit').on('submit', function(e) {
        e.preventDefault();
        var btn = $('#btnGuardar');
        var idTratamiento = '@Model.IdTratamiento'; // Obtenemos el ID correctamente

        btn.prop('disabled', true).html('<i class="fas fa-sync fa-spin me-2"></i> Actualizando...');

        $.ajax({
            url: '@Url.Action("GuardarBitacora", "Tratamientos")',
            type: 'POST',
            data: $(this).serialize(),
            success: function(res) {
    if(res.success) {
        // Generamos la URL base con el helper y añadimos el ID del tratamiento
        // Esto evita la duplicación de IDs en la barra de direcciones
        var baseUrl = '@Url.Action("Bitacora", "Tratamientos", new { id = "_ID_" })';
        var finalUrl = baseUrl.replace("_ID_", res.id);

        loadView(finalUrl);
    } else {
        alert("Error: " + res.message);
    }
},
            error: function() {
                alert("Error de red o sesión expirada.");
                btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i> Guardar Historial');
            }
        });
    });
</script>