@model SGRC_Integrador.Models.Tratamiento
@{
    var riesgo = ViewBag.RiesgoInfo as SGRC_Integrador.Models.Riesgo;
    Layout = null;
}

<div class="container py-4 fade-in">
    <div>
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="fw-bold m-0">Riesgo #@riesgo.IdRiesgo: @riesgo.Amenaza</h2>
                <p class="mb-0 opacity-75">Activo: @(riesgo.Activo?.Nombre ?? "N/A") | Valoración Inherente: <span class="badge bg-danger">@riesgo.NivelRiesgo</span></p>
            </div>
        </div>
    </div>

    <form id="formGestionar" action="@Url.Action("Gestionar", "Tratamientos")" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="IdRiesgo" value="@riesgo.IdRiesgo" />
        <input type="hidden" name="Estrategia" id="inputEstrategia" required />

        <label class="form-label fw-bold mb-3 text-navy">1. Definir Estrategia de Tratamiento</label>
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="strategy-card p-3 border rounded-4 text-center cursor-pointer" onclick="selectStrategy('Mitigar', this)">
                    <i class="fas fa-user-shield fa-2x mb-2 text-primary"></i>
                    <h6 class="fw-bold m-0">Mitigar</h6>
                </div>
            </div>
            <div class="col-md-3">
                <div class="strategy-card p-3 border rounded-4 text-center cursor-pointer" onclick="selectStrategy('Transferir', this)">
                    <i class="fas fa-exchange-alt fa-2x mb-2 text-warning"></i>
                    <h6 class="fw-bold m-0">Transferir</h6>
                </div>
            </div>
            <div class="col-md-3">
                <div class="strategy-card p-3 border rounded-4 text-center cursor-pointer" onclick="selectStrategy('Evitar', this)">
                    <i class="fas fa-hand-paper fa-2x mb-2 text-danger"></i>
                    <h6 class="fw-bold m-0">Evitar</h6>
                </div>
            </div>
            <div class="col-md-3">
                <div class="strategy-card p-3 border rounded-4 text-center cursor-pointer" onclick="selectStrategy('Aceptar', this)">
                    <i class="fas fa-check-double fa-2x mb-2 text-success"></i>
                    <h6 class="fw-bold m-0">Aceptar</h6>
                </div>
            </div>
        </div>

        <div id="panelISO" class="card p-3 mb-4 border-start border-primary border-5 bg-light shadow-sm" style="display:none;">
            <label class="form-label fw-bold text-primary"><i class="fas fa-book-reader me-2"></i>Control Normativo ISO 27002:2022</label>
            <select name="ControlISO" class="form-select">
                <option value="">-- Seleccione el control técnico --</option>
                <option value="5.17">5.17 Autenticación Multifactor (MFA)</option>
                <option value="8.1">8.1 Seguridad de Endpoints</option>
                <option value="8.20">8.20 Seguridad de Redes</option>
                <option value="8.24">8.24 Gestión de Incidentes</option>
            </select>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card p-4 rounded-4 shadow-sm border-0 h-100 bg-white">
                    <h5 class="fw-bold text-navy mb-3"><i class="fas fa-vial me-2"></i>Simulador de Riesgo Residual</h5>
                    <div class="mb-3">
                        <label class="small fw-bold">Probabilidad Post-Control (1-5)</label>
                        <input type="range" name="nuevaProbabilidad" class="form-range" min="1" max="5" value="2" id="rangeProb" oninput="calcResidual()">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Impacto Post-Control (1-5)</label>
                        <input type="range" name="nuevoImpacto" class="form-range" min="1" max="5" value="@riesgo.Impacto" id="rangeImp" oninput="calcResidual()">
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-center">
                <div class="card p-4 rounded-4 shadow-sm border-0 h-100 bg-white">
                    <h5 class="fw-bold mb-3">Mitigación Visual</h5>
                    <div class="d-flex align-items-end justify-content-center gap-5" style="height: 120px;">
                        <div>
                            <div class="bg-danger rounded-top shadow-sm" style="width: 45px; height: @(riesgo.NivelRiesgo * 5)px;"></div>
                            <small class="fw-bold d-block mt-2">Antes (@riesgo.NivelRiesgo)</small>
                        </div>
                        <div>
                            <div id="barResidual" class="bg-success rounded-top shadow-sm" style="width: 45px; height: 20px; transition: 0.5s;"></div>
                            <small class="fw-bold d-block mt-2">Después (<span id="txtResidual">--</span>)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-4 rounded-4 border-0 shadow-sm mb-4 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0 text-navy"><i class="fas fa-chart-line me-2"></i>Indicadores (KPIs)</h5>
                <button type="button" class="btn btn-sm btn-outline-navy" onclick="addKPI()">+ Añadir</button>
            </div>
            <div id="kpi-container">
                <div class="kpi-row row g-2 mb-3 align-items-end border-bottom pb-3">
                    <div class="col-md-5">
                        <input type="text" name="kpi_nombre[]" class="form-control" placeholder="Nombre del KPI">
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="kpi_meta[]" class="form-control" placeholder="Meta %">
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">Cada</span>
                            <input type="number" name="kpi_frec_valor[]" class="form-control" value="1">
                            <select name="kpi_frec_unidad[]" class="form-select">
                                <option value="Semanas">Semanas</option>
                                <option value="Meses">Meses</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-4 rounded-4 shadow-sm border-0 mb-4 bg-white">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label fw-bold">Acción Correctiva</label>
                    <textarea name="AccionCorrectiva" class="form-control" rows="3" required></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Responsable del Plan</label>
                    <input type="text"
                           name="Responsable"
                           id="inputResponsable"
                           class="form-control"
                           required
                           value="@ViewBag.UsuarioActual"
                           readonly />
                    <small id="helpResponsable" class="text-primary fw-bold" style="display:none; font-size: 0.75rem;">
                        <i class="fas fa-info-circle me-1"></i>Estrategia externa: Ingrese la entidad o tercero responsable.
                    </small>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Fecha Límite</label>
                    <input type="date" name="FechaLimite" class="form-control" required />
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-navy btn-lg w-100 rounded-pill shadow mt-3 py-3">
            <i class="fas fa-save me-2"></i>Ejecutar Plan de Tratamiento
        </button>
    </form>
</div>

<div class="modal fade" id="modalEtica" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">ADVERTENCIA LOPDP</h5>
            </div>
            <div class="modal-body p-4 text-center">
                <i class="fas fa-gavel fa-4x text-danger mb-3"></i>
                <p>Está aceptando un riesgo Crítico/Alto. Esto implica responsabilidad legal directa según <strong>Art. 42 LOPDP</strong>.</p>
                <p class="small text-muted">¿Confirma bajo su responsabilidad profesional?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" onclick="revertirAceptar()">Revisar</button>
                <button type="button" class="btn btn-danger rounded-pill" data-bs-dismiss="modal">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Guardamos el usuario en una variable JavaScript al inicio
    var usuarioSesion = "@ViewBag.UsuarioActual";

    function selectStrategy(val, el) {
        $('.strategy-card').removeClass('border-navy bg-light shadow-sm').addClass('border-secondary opacity-75');
        $(el).addClass('border-navy bg-light shadow-sm').removeClass('border-secondary opacity-75');
        $('#inputEstrategia').val(val);

        if (val === 'Mitigar') $('#panelISO').slideDown(); else $('#panelISO').slideUp();

        // LÓGICA RESPONSABLE DINÁMICO
        var inputResp = $('#inputResponsable');
        var helpResp = $('#helpResponsable');

        if (val === 'Transferir') {
            inputResp.prop('readonly', false).val("").focus().addClass('border-primary');
            helpResp.fadeIn();
        } else {
            inputResp.prop('readonly', true).val(usuarioSesion).removeClass('border-primary');
            helpResp.fadeOut();
        }

        if (val === 'Aceptar' && @riesgo.NivelRiesgo >= 12) {
            $('#modalEtica').modal('show');
        }
    }

    function calcResidual() {
        let p = $('#rangeProb').val();
        let i = $('#rangeImp').val();
        let res = p * i;
        $('#txtResidual').text(res);
        $('#barResidual').css('height', (res * 5) + 'px');
    }

    function addKPI() {
        var html = `<div class="kpi-row row g-2 mb-3 align-items-end border-bottom pb-3 fade-in">
            <div class="col-md-5"><input type="text" name="kpi_nombre[]" class="form-control" placeholder="Nombre KPI"></div>
            <div class="col-md-2"><input type="number" name="kpi_meta[]" class="form-control" placeholder="%"></div>
            <div class="col-md-4"><input type="text" class="form-control" value="Cada 1 Semanas" readonly></div>
            <div class="col-md-1"><button type="button" class="btn btn-danger w-100" onclick="$(this).closest('.kpi-row').remove()">x</button></div>
        </div>`;
        $('#kpi-container').append(html);
    }

    function revertirAceptar() {
        $('#modalEtica').modal('hide');
        $('.strategy-card').first().click();
    }

    $('#formGestionar').submit(function (e) {
    e.preventDefault();
    $.ajax({
        url: $(this).attr('action'),
        type: 'POST',
        data: $(this).serialize(),
        xhrFields: {
            withCredentials: true  // Mantener sesión
        },
        success: function () {
            loadView('@Url.Action("Index", "Riesgos")');
        },
        error: function(xhr) {
            alert('Error al guardar: ' + xhr.responseText);
        }
    });
});

    // Inicialización al cargar la página
    calcResidual();
    $('.strategy-card').first().click();
</script>