<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="~/Content/Site.css">
</head>
<body>
    <div class="page-wrapper">

        <div class="sidebar">
            <div class="bar">

                <div class="logo-container">
                    <img src="@Url.Content("~/Content/Images/logo.svg")" alt="logo" class="logo-bar" />
                </div>

                <div class="buttons-container">

                    <button class="sidebar-btn @(ViewContext.RouteData.Values["controller"].ToString() == "Home" ? "active" : "")"
                            onclick="loadView('@Url.Action("Index", "Home")')">
                        <div class="icon-wrap">
                            <i class="fas fa-home"></i>
                        </div>
                        <span class="link-text">Dashboard</span>
                    </button>

                    <button class="sidebar-btn @(ViewContext.RouteData.Values["controller"].ToString() == "Activos" ? "active" : "")"
                            onclick="loadView('@Url.Action("Index", "Activos")')">
                        <div class="icon-wrap">
                            <i class="fas fa-server"></i>
                        </div>
                        <span class="link-text">Activos</span>
                    </button>

                    <button class="sidebar-btn @(ViewContext.RouteData.Values["controller"].ToString() == "Riesgos" ? "active" : "")"
                            onclick="loadView('@Url.Action("Index", "Riesgos")')">
                        <div class="icon-wrap">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <span class="link-text">Riesgos</span>
                    </button>

                    <button class="sidebar-btn @(ViewContext.RouteData.Values["controller"].ToString() == "Tratamientos" ? "active" : "")"
                            onclick="loadView('@Url.Action("Index", "Tratamientos")')">
                        <div class="icon-wrap">
                            <i class="fas fa-notes-medical"></i>
                        </div>
                        <span class="link-text">Tratamiento</span>
                    </button>

                    <button class="sidebar-btn @(ViewContext.RouteData.Values["controller"].ToString() == "Reportes" ? "active" : "")"
                            onclick="loadView('@Url.Action("Index", "Reportes")')">
                        <div class="icon-wrap">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <span class="link-text">Reportes</span>
                    </button>

                </div>

            </div>
        </div>

        <div class="dashboard" id="main-content">
            @RenderBody()
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Función para cargar vistas vía AJAX
        function loadView(url) {
            $.ajax({
                url: url,
                type: 'GET',
                cache: false,
                xhrFields: {
                    withCredentials: true  // ESTO ES CRÍTICO para mantener la sesión
                },
                success: function (data) {
                    $('#main-content').html(data);  // o el contenedor que uses
                },
                error: function () {
                    alert('Error al cargar la vista');
                }
            });
        }

        // 2. Lógica para el "Botón Rojo" (Active State)
        // Esto se ejecuta cada vez que haces clic en un botón del sidebar
        $(document).on('click', '.sidebar-btn', function () {
            // A. Quitar la clase 'active' (rojo) de todos los botones
            $('.sidebar-btn').removeClass('active');

            // B. Agregar la clase 'active' (rojo) SOLO al que hiciste clic
            $(this).addClass('active');
        });

        // 3. (Opcional) Mantener el botón activo si recargas la página
        $(document).ready(function () {
            var path = window.location.pathname;

            // Si la URL contiene "Activos", activa el botón de Activos, etc.
            if (path.includes("Activos")) {
                $('.sidebar-btn').removeClass('active'); // Limpia home
                // Busca el botón que tenga el onclick hacia Activos y actívalo
                $('button[onclick*="Activos"]').addClass('active');
            } else if (path.includes("Riesgos")) {
                $('.sidebar-btn').removeClass('active');
                $('button[onclick*="Riesgos"]').addClass('active');
            } else if (path.includes("Tratamiento")) {
                $('.sidebar-btn').removeClass('active');
                $('button[onclick*="Tratamiento"]').addClass('active');
            } else if (path.includes("Reportes")) {
                $('.sidebar-btn').removeClass('active');
                $('button[onclick*="Reportes"]').addClass('active');
            }
            // Si es Home, ya viene activo por defecto desde el HTML
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <script>
        // 1. Función de Carga AJAX
        function loadView(url) {
            if (!url) return;

            // Efecto visual de carga
            $('#main-content').css('opacity', '0.5');

            $.get(url, function (data) {
                $('#main-content').html(data);
                $('#main-content').css('opacity', '1');

                // Actualizar sidebar después de cargar
                updateSidebar(url);

            }).fail(function () {
                $('#main-content').html('<div class="alert alert-danger">Error de conexión.</div>');
                $('#main-content').css('opacity', '1');
            });
        }

        // 2. Función Inteligente para Activar Botones
        function updateSidebar(url) {
            // A. Limpiamos todos los botones primero
            $('.sidebar-btn').removeClass('active');

            // B. Lógica de selección
            if (url.includes("Activos")) {
                $('button[onclick*="Activos"]').addClass('active');
            }
            else if (url.includes("Riesgos")) {
                $('button[onclick*="Riesgos"]').addClass('active');
            }
            else if (url.includes("Tratamiento")) {
                $('button[onclick*="Tratamiento"]').addClass('active');
            }
            else if (url.includes("Reportes")) {
                $('button[onclick*="Reportes"]').addClass('active');
            }
            else {
                // CASO HOME / DASHBOARD (CORREGIDO)
                // En lugar de buscar "Home" en la URL (que a veces no está),
                // buscamos el botón que contiene el texto "Dashboard".

                var btnDashboard = $('.sidebar-btn').filter(function () {
                    // Buscamos el botón cuyo texto sea "Dashboard"
                    return $(this).text().trim().includes("Dashboard");
                });

                // Si lo encontramos, lo activamos
                if (btnDashboard.length > 0) {
                    btnDashboard.addClass('active');
                } else {
                    // Plan B: Si no lo encuentra por texto, activa el PRIMER botón (que suele ser Home)
                    $('.sidebar-btn').first().addClass('active');
                }
            }
        }

        // 3. Respuesta Inmediata al Clic (UX)
        // Esto hace que se ponga rojo apenas haces clic, sin esperar al servidor
        $(document).on('click', '.sidebar-btn', function () {
            $('.sidebar-btn').removeClass('active');
            $(this).addClass('active');
        });

        // 4. Al recargar la página (F5)
        $(document).ready(function () {
            var currentUrl = window.location.pathname;
            updateSidebar(currentUrl);
        });
    </script>
</body>
</html>
